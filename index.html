<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Localização</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #map {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex items-center justify-center">

    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full transition-all duration-300">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Localização em Grupo</h1>
        <p class="text-center text-gray-600 mb-6">Compartilhe sua localização em tempo semi-real.</p>

        <!-- User Details Section -->
        <div id="auth-container" class="mb-6">
            <h2 class="text-xl font-semibold mb-2 text-gray-700">Detalhes do Usuário</h2>
            <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
                <p class="text-sm font-medium text-gray-500">
                    Seu ID: <span id="user-id" class="text-gray-800 font-bold break-all">Aguardando...</span>
                </p>
                <p class="text-sm font-medium text-gray-500 mt-2">
                    Status: <span id="status-message" class="text-blue-600 font-bold">Iniciando...</span>
                </p>
            </div>
        </div>

        <!-- Group Management Section -->
        <div id="group-container" class="mb-6">
            <h2 class="text-xl font-semibold mb-2 text-gray-700">Identificação</h2>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 mb-4">
                <input
                    type="text"
                    id="name-input"
                    placeholder="Digite seu nome ou apelido..."
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
            </div>
            <button
                id="start-tracking-button"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md"
            >
                Iniciar Rastreamento
            </button>
        </div>

        <!-- Map Section -->
        <div id="map" class="rounded-xl shadow-lg"></div>

        <!-- Message Box -->
        <div id="message-box-container"></div>
    </div>

    <!-- Google Maps API script -->
    <!-- ESTE É O LOCAL PARA COLAR A SUA CHAVE DA API DO GOOGLE MAPS -->
    <!-- Substitua 'YOUR_GOOGLE_MAPS_API_KEY' pela sua chave de API real. -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJNoC6iKWDwxtD5YjTcUve0IUG8aJyY14&callback=initMap" async defer></script>

    <script type="text/javascript">
        // Defina a URL do seu Google Apps Script aqui
        // SUBSTITUA 'YOUR_APPS_SCRIPT_URL' PELA URL OBTIDA NA IMPLANTAÇÃO.
        const APPS_SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL';

        let map;
        let markers = {}; // Objeto para armazenar os marcadores
        let trackingInterval = null;

        // Custom function to display messages instead of alerts
        const showMessage = (text, type = 'info') => {
            const container = document.getElementById('message-box-container');
            container.innerHTML = '';
            const messageBox = document.createElement('div');
            messageBox.textContent = text;
            let classes = 'mt-4 p-4 rounded-xl text-center font-medium';
            if (type === 'success') classes += ' bg-green-100 text-green-800';
            if (type === 'error') classes += ' bg-red-100 text-red-800';
            if (type === 'info') classes += ' bg-blue-100 text-blue-800';
            messageBox.className = classes;
            container.appendChild(messageBox);
        };

        // Initialize the Google Map
        function initMap() {
            if (map) return;
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 0, lng: 0 },
                zoom: 2,
            });
        }

        // Geolocation success callback
        const onLocationSuccess = async (position) => {
            const userId = document.getElementById('user-id').textContent;
            const name = document.getElementById('name-input').value.trim() || `User-${userId.substring(0, 5)}`;
            const { latitude: lat, longitude: lon } = position.coords;

            const url = `${APPS_SCRIPT_URL}?action=write&userId=${encodeURIComponent(userId)}&name=${encodeURIComponent(name)}&lat=${lat}&lon=${lon}`;

            try {
                const response = await fetch(url, { method: 'POST' });
                const result = await response.text();
                if (result !== 'OK') {
                    console.error("Erro ao escrever no Google Sheet:", result);
                }
            } catch (e) {
                console.error("Erro na requisição para o Google Apps Script:", e);
                showMessage("Erro de conexão. Verifique a URL do Apps Script.", 'error');
            }
        };

        // Geolocation error callback
        const onLocationError = (error) => {
            let errorMessage = "Ocorreu um erro desconhecido na geolocalização.";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Permissão de geolocalização negada. Por favor, habilite-a nas configurações do navegador.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Localização indisponível. Verifique se o GPS está ativado.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Tempo limite excedido ao tentar obter a localização.";
                    break;
            }
            document.getElementById('status-message').textContent = "Erro de localização";
            showMessage(errorMessage, 'error');
        };

        // Function to read data from Google Sheet and update map
        const updateMap = async () => {
            if (!map) return;
            const url = `${APPS_SCRIPT_URL}?action=read`;
            try {
                const response = await fetch(url);
                const users = await response.json();
                
                const currentUsers = {};

                users.forEach(user => {
                    if (user.lat && user.lon) {
                        const position = { lat: parseFloat(user.lat), lng: parseFloat(user.lon) };
                        const name = user.name || `User-${user.userId.substring(0, 5)}`;
                        currentUsers[user.userId] = true;

                        if (markers[user.userId]) {
                            markers[user.userId].setPosition(position);
                            markers[user.userId].setTitle(name);
                        } else {
                            // Create a new marker
                            markers[user.userId] = new google.maps.Marker({
                                position: position,
                                map: map,
                                title: name,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 10,
                                    fillColor: '#FF0000',
                                    fillOpacity: 0.8,
                                    strokeWeight: 0,
                                }
                            });
                        }
                    }
                });

                // Remove markers for users no longer in the sheet
                Object.keys(markers).forEach(userId => {
                    if (!currentUsers[userId]) {
                        markers[userId].setMap(null);
                        delete markers[userId];
                    }
                });

                // Center map on the first user if available
                if (users.length > 0 && users[0].lat && users[0].lon) {
                    map.setCenter({ lat: parseFloat(users[0].lat), lng: parseFloat(users[0].lon) });
                    map.setZoom(14);
                }

            } catch (e) {
                console.error("Erro ao ler dados da Google Sheet:", e);
            }
        };

        // Event listener to start tracking
        document.getElementById('start-tracking-button').addEventListener('click', () => {
            if (trackingInterval) return; // Already tracking

            const nameInput = document.getElementById('name-input');
            if (nameInput.value.trim() === '') {
                showMessage("Por favor, digite seu nome antes de iniciar.", 'error');
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(onLocationSuccess, onLocationError, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                });
                trackingInterval = setInterval(updateMap, 5000); // Update every 5 seconds
                showMessage("Rastreamento iniciado! Aguarde alguns instantes para ver os outros usuários.", 'success');
            } else {
                showMessage('Seu navegador não suporta a Geolocation API.', 'error');
            }
        });

        // Generate a random user ID on load
        document.addEventListener('DOMContentLoaded', () => {
            const userId = 'user_' + Math.random().toString(36).substring(2, 8);
            document.getElementById('user-id').textContent = userId;
            document.getElementById('status-message').textContent = 'Pronto para iniciar.';
        });
    </script>
</body>
</html>
